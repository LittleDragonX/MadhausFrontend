<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>发布商品</title>
	<link href="../../../css/Hui.css" rel="stylesheet" type="text/css" />
	<style type="text/css">
		input.H-textbox {
			border-width: 0;
			color: #999;
			min-width: 100px;
		}

		.H-badge {
			padding-right: 5px;
			color: #999;
		}

		.select {
			text-align: right;
			vertical-align: middle;
			border: 0;
			width: 100%;
			height: 48px;
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			color: #999;
			cursor: pointer;
			background-color: white;
			outline: none;
			tap-highlight-color: rgba(255, 255, 255, 0);
			-webkit-tap-highlight-color: rgba(255, 255, 255, 0);
		}

		.select option {
			direction: rtl;
		}
	</style>
</head>

<body>
	<div id="content">
		<div onclick="openUploadImg()" tapmode="" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-center-all" style="max-height:200px;display:none;" v-show="initData.isShow">
			<img id="pic" src="../../../image/addPic.png" class="H-width-100-percent">
		</div>
		<div onclick="openUploadImg()" tapmode="" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active">
			<div class="H-flex-item H-padding-12 H-font-size-16">
				商品主图添加
			</div>
			<span class="H-icon H-padding-horizontal-both-12 H-display-block H-border-horizontal-left-after"><i class="H-iconfont H-icon-thumb H-font-size-24 H-vertical-middle" style="color:#FF7C48;"></i></span>
		</div>
		<div class="H-padding-vertical-bottom-10"></div>
		<div class="H-theme-background-color-white H-text-list H-flexbox-horizontal H-vertical-middle H-border-vertical-bottom-margin-both-10-after">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
				是否重点推荐
			</div>
			<input type="checkbox" v-model="jsonData.level" class="H-switch H-display-block H-position-relative H-theme-background-color-white H-theme-font-color8 H-margin-horizontal-right-10">
		</div>
		<div class="H-flexbox-horizontal H-border-vertical-bottom-margin-both-10-after">
			<span class="H-vertical-middle H-padding-horizontal-left-10 H-theme-background-color-white H-font-size-16">商品标题</span>
			<input type="text" class="H-textbox H-vertical-align-middle H-vertical-middle H-font-size-16 H-flex-item H-box-sizing-border-box H-border-none H-outline-none H-padding-12 H-text-align-right" v-model="jsonData.name" placeholder="输入商品标题">
		</div>
		<!--<div onclick="vm.openItemInfo()" tapmode="" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active" v-show="initData.isShow_open">
			<div class="H-flex-item H-padding-12 H-font-size-16">
			活动类型
			</div>
			<span class="H-badge H-display-block" v-text="jsonData.manager_name">电影</span>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-16 H-vertical-middle"></i></span>
			</div>-->
		<div onclick="openGoodsType()" tapmode="" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
				商品类型
			</div>
			<span id="start_time" class="H-badge H-display-block" v-text="initData.typeName"></span>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-16 H-vertical-middle"></i></span>
		</div>
		<div class="H-padding-vertical-bottom-10"></div>
		<div onclick="openContent()" tapmode="" class="H-theme-background-color-white H-theme-font-color-999 H-padding-10" style="min-height:80px;" v-html="jsonData.content">
			编辑商品详情
		</div>
		<div class="H-padding-vertical-bottom-10"></div>
		<div onclick="openGoodsSpec()" tapmode="" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12 H-theme-font-color-999">
				商品规格
			</div>
			<span class="H-badge H-display-block" v-text="initData.specMsg"></span>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-16 H-vertical-middle"></i></span>
		</div>
		<div onclick="openGoodsSpec()" tapmode="" class="H-flexbox-horizontal H-border-vertical-bottom-margin-both-10-after">
			<span class="H-vertical-middle H-padding-horizontal-left-10 H-theme-background-color-white H-font-size-16">名称</span>
			<input type="text" class="H-textbox H-vertical-align-middle H-vertical-middle H-font-size-16 H-flex-item H-box-sizing-border-box H-border-none H-outline-none H-padding-12 H-text-align-right" readonly v-model="initData.ps_name" placeholder="请输入商品规格名称">
		</div>
		<div onclick="openGoodsSpec()" tapmode="" class="H-flexbox-horizontal H-border-vertical-bottom-margin-both-10-after">
			<span class="H-vertical-middle H-padding-horizontal-left-10 H-theme-background-color-white H-font-size-16">价格</span>
			<input type="number" class="H-textbox H-vertical-align-middle H-vertical-middle H-font-size-16 H-flex-item H-box-sizing-border-box H-border-none H-outline-none H-padding-12 H-text-align-right" readonly v-model="initData.ps_fee" placeholder="0">
		</div>
		<!-- <div class="H-flexbox-horizontal H-border-vertical-bottom-margin-both-10-after">
			<span class="H-vertical-middle H-padding-horizontal-left-10 H-theme-background-color-white H-font-size-16">运费</span>
			<input type="number" class="H-textbox H-vertical-align-middle H-vertical-middle H-font-size-16 H-flex-item H-box-sizing-border-box H-border-none H-outline-none H-padding-12 H-text-align-right" v-model="jsonData.logic_fee" placeholder="0.00">
		</div> -->
		<div class="H-padding-vertical-bottom-10"></div>
		<div class="H-flexbox-horizontal">
			<span class="H-vertical-middle H-padding-horizontal-left-10 H-theme-background-color-white H-font-size-16">联系电话</span>
			<input type="number" class="H-textbox H-vertical-align-middle H-vertical-middle H-font-size-16 H-flex-item H-box-sizing-border-box H-border-none H-outline-none H-padding-12 H-text-align-right" v-model="jsonData.contact_way" placeholder="请输入电话号码">
		</div>
		<div style="height: 48px;"></div>
		<div class="H-flexbox-horizontal H-box-sizing-border-box" style="position: fixed;bottom:0px;z-index: 10000;">
			<div tapmode="" onclick="vm.btnSubmit()" class="H-flex-item H-center-all H-padding-vertical-both-12 H-font-size-16 H-theme-font-color-white" style="background-color:#ff7c48;">
				确定编辑
			</div>
		</div>
	</div>
	<script type="text/javascript" src="../../../script/api.js"></script>
	<script type="text/javascript" src="../../../script/H.js"></script>
	<script type="text/javascript" src="../../../script/vue.js"></script>
	<script type="text/javascript" src="../../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../../script/setting.js"></script>
	<script type="text/javascript" src="../../../script/upload.js"></script>
	<script type="text/javascript">
		var vm = null;
		initVue();
		apiready = function() {
			getGoodsInfo();
			initRequire();
			api.addEventListener({
			    name: 'setContentData'
			}, function(ret, err){
			    if( ret ){
			         setContent(ret.value.content);
			    }else{
			         alert( JSON.stringify( err ) );
			    }
			});
			api.addEventListener({
			    name: 'loadGoodsEditData'
			}, function(ret, err){
			    if( ret ){
			         getGoodsInfo();
			    }else{
			         alert( JSON.stringify( err ) );
			    }
			});
		};
		function initRequire() {
			require();
			isIOS = api.systemType == "ios" ? true : false;
		};
		function initVue() {
			vm = new Vue({
				el: '#content',
				data: {
					jsonData: {
						name: null,
						content: '点击编辑商品详情',
						type: null,
						logic_fee: 0,
						pic: null,
						level: false,
						contact_way: null
					},
					initData: {
						isShow: false,
						typeName: null,
						specMsg:null,
						ps_name: null,
						ps_fee: 0,
					}
				},
				methods: {
					btnSubmit: function() {
						this.addItemInfo();
					},
					addItemInfo: function() {
						var jsonData = this.jsonData;
						log(jsonData);
						//删除对象(属性=null)
						for (var key in jsonData) {
							if (jsonData[key] == false) {
								jsonData[key] = 0;
							}
							if (jsonData[key] == true) {
								jsonData[key] = 1;
							}
							if (jsonData[key] == null) {
								delete jsonData[key];
							}
						}
						log(jsonData);
						var id = api.pageParam.id;
						// jsonData.product_id = id;
						var url = '/fenggou/products/' + id + '/';

						// var url = '/fengyue/join/7/';
						// ajaxs(url, 'PATCH', {status:2}, true, function(ret) {
						// 	log(ret, true);
						// 	if(ret.id){
						// 		H.toast('提交成功')
						// 	}else{
						// 		H.toast('提交失败')
						// 	}
						// },function(ret,err){
						// 	log(err, true);
						// })
						// return;

						ajaxs(url, 'PUT', jsonData, true, function(ret) {
							log(ret, true);
							if (ret.id == id) {
								api.toast({
									msg: '编辑成功 ✓',
									duration: 1500,
									location: 'middle'
								});
								api.sendEvent({
									name: 'loadingGoodsData',
									extra: {
										key1: '1'
									}
								});
								api.closeWin();
							} else {
								api.toast({
									msg: '操作失败',
									duration: 1500,
									location: 'middle'
								});
							}
						}, function(ret, err) {

						});

					}
				}
			});
		};

		function setGoodsType(id, name) {
			vm.initData.typeName = name;
			vm.jsonData.type = id;
		};

		function openWins(title, name, url, type) {
			H.openWin('base_head_' + name, 'goods_wins_head.html', {
				title: title,
				name: name,
				url: url,
				type: type,
				id: api.pageParam.id,
				str: 'edit'
			});
		};

		function openGoodsType() {
			openWins('商品类型', 'goods_type_body', 'goods_type_body.html', 1);
		};

		function openGoodsSpec(id) {
			openWins('商品规格', 'goods_spec_body', 'goods_spec_body.html', 2);
		};

		function openContent() {
			H.openWin('base_head_goods_content_edit_body', 'widget://html/comPages/detail_head.html', {
				title: '编辑商品详情',
				name: 'goods_content_edit_body',
				url: '../admin/buy/goods_content_edit_body.html',
				content: vm.jsonData.content
			});
		};

		function setContent(html) {
			vm.jsonData.content = html;
		};
		function setSpec() {
			vm.initData.specMsg = '点击编辑规格';
		};

		function getGoodsInfo() {
			var id = api.pageParam.id;
			var url = '/fenggou/products/' + id + '/';
			ajaxs(url, 'get', null, true, function(ret) {
				log(ret, true);
				vm.initData.typeName = ret.type_name;
				vm.jsonData.type = ret.type;
				vm.jsonData.name = ret.name;
				vm.jsonData.level = ret.level == 0 ? false : true;
				vm.jsonData.logic_fee = ret.logic_fee;
				vm.jsonData.content = ret.content?ret.content:'点击编辑商品详情';
				vm.jsonData.fee = ret.fee;
				vm.jsonData.contact_way = ret.contact_way;
				vm.jsonData.repertory = ret.repertory;
				vm.jsonData.pic = ret.pic;
				vm.initData.isShow = true;
				$('#pic').attr('src',ret.pic + '?imageView2/1/w/750/h/334/interlace/0/q/100');
				var item = ret.ps_product;
				for(var p in item){
					if(item[p].is_default==1){
						vm.initData.ps_name =  item[p].standard;
						vm.initData.ps_fee =  item[p].fee;
					}
				}
			}, function(ret, err) {

			});
		};
		//上传图片
		function openUploadImg() {
			openActionSheet(function(img) {
				getTokens(img);
			})
		};

		function getTokens(img) {
			api.showProgress({
			    style: 'default',
			    animationType: 'fade',
			    title: '努力加载中...',
			    text: '先喝杯茶...',
			    modal: false
			});
			var url = window.server + '/common/qiniu/get/token/';
			api.ajax({
				url: url,
				method: "get",
				headers: {
					"X-CSRFToken": $api.getStorage('userInfo').token
				}
			}, function(ret, err) {
				if (ret) {
					log(ret, true);
					uploadImg(img, ret.data)
				} else {
					log(err, true);
				}
			});
		};

		function uploadImg(img, res) {
			var data = {
				files: {
					file: img
				},
				values: {
					token: res.token,
					key: res.key
				}
			};
			api.ajax({
				url: "http://up-z2.qiniu.com/",
				data: data,
				dataType: "json",
				method: "post"
			}, function(ret, err) {
				api.hideProgress();
				if (ret) {
					log(ret, true);
					vm.jsonData.pic=res.pic_path;
					$('#pic').attr('src',res.pic_path);
					// $('#pic').css({
					// 	'background': 'url(' + res.pic_path + ') no-repeat left top'
					// })
				} else {
					alert('上传失败');
					//log(err, true);
				}
			});
		};
	</script>
</body>

</html>
