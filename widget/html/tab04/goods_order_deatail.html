<!doctype html>
<html id="ht">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>商品支付</title>
	<link href="../../css/Hui.css" rel="stylesheet" type="text/css" />
	<style type="text/css">
		html,
		body {
			padding: 0;
			margin: 0;
		}

		.ios {
			background: rgba(0, 0, 0, 0.5);
		}

		.payActive .H-icon-radio-check {
			color: #FF7C47;
		}

		.payActive .H-icon-radio-check:before {
			content: "\f258";
		}

		input.H-textbox {
			border-width: 0;
			color: #999;
			min-width: 100px;
		}

		.H-badge {
			padding-right: 5px;
			color: #999;
		}
	</style>
</head>

<body class="H-flexbox-vertical" id="bdy">
	<div id="payList" class="H-theme-background-color-white">
		<div onclick="openAddress()" tapmode="" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-16 H-padding-vertical-both-12">
				收货地址
			</div>
			<span id="address" class="H-badge H-display-block">选择地址</span>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-16 H-vertical-middle"></i></span>
		</div>
		<div class="H-channel-text H-flex-item H-font-size-16 H-padding-10 H-text-show-row-1 H-border-vertical-bottom-after">
			选择支付方式
		</div>
		<div onclick="selectPay(this)" tapmode="" data-type="wxpay" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active payActive">
			<div class="H-padding-horizontal-left-10 H-padding-vertical-both-10">
				<span class="H-icon H-center-all H-theme-background-color9 H-border-radius-circle H-margin-horizontal-auto" style="height: 42px; width: 42px; "><i class="H-iconfont H-icon-weixin H-font-size-22 H-theme-font-color-white"></i></span>
			</div>
			<div class="H-flex-item H-font-size-16 H-flexbox-vertical H-padding-horizontal-both-10">
				微信
			</div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-radio-check H-font-size-28 H-theme-font-color-999 H-vertical-middle"></i></span>
		</div>
		<div onclick="selectPay(this)" tapmode="" data-type="alipay" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active">
			<div class="H-padding-horizontal-left-10 H-padding-vertical-both-10">
				<span class="H-icon H-center-all H-theme-background-color1 H-border-radius-circle H-margin-horizontal-auto" style="height: 42px; width: 42px; "><i class="H-iconfont H-icon-alipay H-font-size-22 H-theme-font-color-white"></i></span>
			</div>
			<div class="H-flex-item H-font-size-16 H-flexbox-vertical H-padding-horizontal-both-10">
				支付宝
			</div>
			<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-radio-check H-theme-font-color-999 H-font-size-28 H-vertical-middle"></i></span>
		</div>
	</div>
	<div class="H-padding-vertical-bottom-10"></div>
	<div class="H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-after H-clear-both">
		<div class="H-padding-vertical-both-10 H-box-sizing-border-box"><img id="imgurl" src="../../image/logo.png" alt="" title="" class="H-display-block H-margin-horizontal-left-10" style="width:80px;height:80px;">
		</div>
		<div class="H-flex-item H-padding-10 H-position-relative H-box-sizing-border-box H-max-width-100-percent H-overflow-hidden" style="height: 100px; ">
			<div class="H-position-relative H-width-100-percent">
				<strong id="name" class="H-font-size-16 H-font-weight-normal font-weight-500 H-text-show-row-1 H-display-block H-box-sizing-border-box">产品名称产品名称产品名称产品名称产品名称产品名称产品名称产品名称产品名称产品名称产品名称产品名称产品名称</strong>
			</div>
			<div id="spec" class="H-font-weight-normal font-weight-500 H-font-size-14 H-display-block H-text-show-row-2 H-theme-font-color-999 H-padding-vertical-top-5">
				蓝色套装
			</div>
			<div class="H-theme-font-color-999 H-font-size-14 H-flexbox-horizontal H-text-horizontal-left H-box-sizing-border-box H-padding-vertical-top-5">
				<span class="H-display-block H-flex-item H-text-align-left H-font-size-15"><span class="H-theme-font-color3">¥<label id="fee">0.00</label></span></span>
				<span class="H-display-block H-flex-item H-text-align-right H-theme-font-color-999 H-font-size-15">x <label id="num">1</label></span>
			</div>
		</div>
	</div>
	<div class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle">
		<div class="H-flex-item H-padding-horizontal-both-10 H-theme-font-color-999 H-padding-vertical-both-12 H-font-size-14">
			运费：¥<label id="log_fee">0.00</label>
		</div>
		<div class="H-padding-horizontal-both-10 H-padding-vertical-both-12 H-font-size-14">
			合计：<span class="H-theme-font-color-red">¥<label id="total_fee">0.00</label> </span>
		</div>
	</div>
	<div class="H-padding-vertical-bottom-10"></div>
	<!-- <div class="H-theme-background-color-white H-padding-vertical-both-8 H-padding-horizontal-both-10">
		<div class="H-font-weight-normal font-weight-500 H-font-size-12 H-display-block H-text-show-row-2 H-theme-font-color-999">
			订单号：W2324242343
		</div>
		<div class="H-font-weight-normal font-weight-500 H-font-size-12 H-display-block H-text-show-row-2 H-theme-font-color-999 H-padding-vertical-top-3">
			创建时间：2017-08-10 15:35
		</div>
	</div> -->
	<div style="height: 55px;"></div>
	<div id="tabNav" class="H-flexbox-horizontal H-box-sizing-border-box H-border-vertical-top-after" style="position: fixed;bottom:0px;z-index: 10000;">
		<div class="H-flex-item H-theme-background-color-white"></div>
		<div class="H-flex-item H-center-all H-theme-background-color-white H-padding-vertical-both-5">
			<div class="H-flex-item H-text-align-center">
				<span class="H-icon H-display-block H-horizontal-center H-font-size-18" style="color: red;"> <label>总计：¥<label id="total_fees">0.00</label> </span>
				<label class="H-display-block H-font-size-12 H-theme-font-color-999">运费：¥<label id="log_fees">0.00</label></label>
			</div>
		</div>
		<div onclick="goPay()" tapmode="" class="H-flex-item H-center-all H-font-size-18 H-theme-font-color-white" style="background-color: #FF7C47;">
			结算
		</div>
	</div>
	<script src="../../script/api.js" type="text/javascript"></script>
	<script src="../../script/H.js" type="text/javascript"></script>
	<script src="../../script/setting.js" type="text/javascript"></script>
	<script src="../../script/zepto.min.js" type="text/javascript"></script>
	<script type="text/javascript">
		var wxPay = null,
			receiveId = null;
		H.ready(function() {
			setBg();
			initData();
			wxPay = api.require('wxPay');
			api.addEventListener({
				name: 'getUserAddressData'
			}, function(ret, err) {
				if (ret) {
					receiveId = ret.value.id;
					var index = ret.value.index;
					$('#address').html('已选择地址'+index);
				} else {
					alert(JSON.stringify(err));
				}
			});

		});

		function initData() {
			var data = api.pageParam.jsonData;
			var item = api.pageParam.item;
			log(item, true)
			$('#imgurl').attr('src', item.pic);
			$('#name').html(item.name);
			$('#spec').html(item.spec);
			$('#fee').html((data.pros[0].pro_fee));
			$('#num').html(data.pros[0].pro_num);
			$('#log_fee').html((data.pros[0].log_fee));
			$('#total_fee').html((data.pros[0].total_fee));
			$('#log_fees').html(data.log_fee);
			$('#total_fees').html(data.should_fee);
		};

		function selectPay(obj) {
			var type = $(obj).attr('data-type');
			$(obj).addClass('payActive').siblings().removeClass('payActive');
		};

		function showPay() {
			$("#enrol").css({
				"display": "none"
			});
			$("#pay").css({
				"display": "block"
			});
		};

		function backEnrol() {
			$("#enrol").css({
				"display": "block"
			});
			$("#pay").css({
				"display": "none"
			});
		};

		function setBg() {
			if (api.systemType == "ios") {
				$("#ht,#bdy").css({
					"background": "rgba(0,0,0,0.6)"
				});
			}
		};

		function btnSubmit() {
			H.toast("开发中")
		};

		function closeFrame() {
			api.closeFrame();
		};

		function openAddress() {
			H.openWin('goods_address_head', 'goods_wins_head.html', {
				title: '我的收货地址',
				name: 'goods_address_body',
				url: 'goods_address_body.html'
			});
		};

		function takeOrder() {
			api.showProgress({
				style: 'default',
				animationType: 'fade',
				modal: true
			});
			var url = '/fenggou/orders/add/';
			var data = api.pageParam.jsonData;
			data.ura_id = receiveId;
			log(data, true)
			ajaxs(url, 'post', data, true, function(ret) {
				log(ret, true);
				if (ret.success === true) {
					var orderId = ret.data.order_id;
					wechatPay(orderId);
				} else {
					log(ret, true);
					H.toast("支付异常，请重试")
				}
			}, function(ret, err) {
				api.hideProgress();
			})
		};

		function goPay() {
			takeOrder();
			// getOrderInfo(orderId);
		};

		function wechatPay(orderId) {
			var url = window.server + "/common/wechat/create/order/";
			api.ajax({
				url: url,
				method: 'post',
				data: {
					values: {
						order_id: orderId
					}
				},
				headers: {
					"X-CSRFToken": $api.getStorage('userInfo').token
				}
			}, function(ret, err) {
				log(ret, true)
				log(err, true)
				if (ret) {
					// goPayOrder(ret.data.wog, orderId);
					wechatApi(orderId);
				} else {
					api.alert({
						msg: JSON.stringify(err)
					});
				}
			});
		};

		function wechatApi(orderId) {
			var url = window.server + "/common/wechat/get/appapi/";
			api.ajax({
				url: url,
				method: 'post',
				data: {
					values: {
						order_id: orderId
					}
				},
				headers: {
					"X-CSRFToken": $api.getStorage('userInfo').token
				}
			}, function(ret, err) {
				log(ret, true)
				log(err, true)
				if (ret) {
					if(ret.success){
						log('success:/common/wechat/get/appapi/',true);
						goPayOrder(ret.data, orderId);
					}else{
						H.toast(ret.msg)
					}
				} else {
					api.alert({
						msg: JSON.stringify(err)
					});
				}
			});
		};

		function goPayOrder(data, orderId) {
			wxPay.payOrder({
				apiKey: data.appid,
				orderId: data.prepayid,
				mchId: data.partnerid,
				nonceStr: data.noncestr,
				timeStamp: data.timestamp,
				sign: data.sign,
				package: 'Sign=WXPay'
			}, function(ret, err) {
				if (ret.status) {
					log('支付成功',true);
					H.toast('支付成功')
					getOrderInfo(orderId);
				} else {
					log('取消支付',true);
					H.toast('取消支付');
				}
			});
		};

		function getOrderInfo(orderId) {
			var url = '/common/wechat/order/query/';
			var data = {
				order_id: orderId
			};
			ajaxs(url, 'get', data, true, function(ret) {
				if (ret.success === true) {
					H.toast('支付成功')
				} else {
					H.toast('支付异常，请重试')
				}
			}, function(ret, err) {
				log('getOrderInfo:/common/wechat/order/query/',true);
				log(ret,true);
				log(err,true)
			})
		};
	</script>
</body>

</html>
