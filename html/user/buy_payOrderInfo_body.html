<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0">
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>play_paysuccess_body</title>
	<link rel="stylesheet" type="text/css" href="../../css/Hui.css">
	<style type="text/css">
		#button2 {
			border-color: #FFF;
			background-color: #FFF;
			color: #2A2A48;
		}

		#button2:active {
			background-color: #FF5440;
			color: #FFF;
		}

		#button3 {
			background-color: #FF8453;
		}

		#button3:active {
			background-color: #ff5440;
			color: #FFF;
		}
	</style>
</head>

<body>
	<div id="itemList" style="display:none;">
		<div class="H-width-100-percent">
			<div class="H-flex-item H-theme-font-color-white H-flexbox-horizontal" style="background-image: linear-gradient(120deg, #FA6B30 0%, #FF8656 100%);">
				<div class="H-padding-vertical-both-25 H-margin-horizontal-both-10">
					<div class="H-font-size-16">
						等待付款
					</div>
					<div class="H-font-size-15 H-margin-vertical-top-3">
						剩23小时53分21秒自动关闭
					</div>
				</div>
				<div class="H-center-all H-margin-horizontal-both-25" style="margin-bottom: auto; margin-top: auto;">
					<img src="../../image/callbackimg.png" alt="" title="" class="imgCache H-display-block" style="width: 75px; height: 75px;">
				</div>
			</div>
			<div class="H-flex-item H-theme-background-color-white H-padding-vertical-both-10 H-padding-horizontal-both-10">
				<div class="H-flexbox-horizontal H-theme-font-color-black H-opacity-1-half">
					<span>收货人 : 雷小春</span>
					<span class="H-flex-item"></span>
					<span>13597119560</span>
				</div>
				<div class="H-theme-font-color-black H-opacity-1-half">
					收货地址 : 广西南宁科苑大道110号
				</div>
			</div>
		</div>
		<div class="H-border-radius3-px H-theme-background-color-white H-margin-vertical-top-10 ">
			<div class="H-flexbox-horizontal H-border-vertical-bottom-after">
				<div class="H-padding-vertical-both-10 H-center-all">
					<img src="../../image/logo.png" srcs="" alt="" title="" class="imgCache H-display-block H-margin-horizontal-left-10" style="width: 65px; height: 65px;">
				</div>
				<div class="H-flex-item H-padding-10">
					<strong class="H-font-weight-normal font-weight-500 H-font-size-16 H-display-block H-text-show-row-1">MARINE国际展览，让你一饱眼福!</strong>
					<div class=" H-theme-font-color-999 H-text-show-row-1 H-margin-vertical-top-5 H-font-size-13">
						规格: 蓝色套装
					</div>
					<div class="H-text-show-row-2 H-font-size-13">
						<span>¥250</span>
						<span class="H-float-right H-icon H-theme-font-color-999"><i class="H-iconfont H-icon-nice H-font-size-14"></i>x 1</span>
					</div>
				</div>
			</div>
			<div class="H-flexbox-horizontal H-padding-vertical-both-10">
				<div class="H-flex-item H-font-size-13 H-padding-horizontal-left-10 H-opacity-1-half" style="width: 48%; margin-bottom: auto; margin-top: auto;">
					报名费 : ￥12.00
				</div>
				<div class="H-font-size-14 H-theme-font-color-999 H-padding-horizontal-right-10">
					<span style="color: #31304C;">合计：</span>
					<span style="color: #FC3337;">￥260</span>
				</div>
			</div>
		</div>
		<div class="H-border-radius3-px H-theme-background-color-white H-margin-vertical-top-10">
			<div class="H-padding-horizontal-left-12 H-padding-vertical-both-8">
				<div class="H-font-size-13 H-opacity-1-half">
					订单号 : 33267291804243069
				</div>
				<div class="H-font-size-13 H-opacity-1-half">
					创建时间 : 2017-07-01 12:06:46
				</div>
			</div>
		</div>
		<div class="H-width-100-percent" style="position: fixed; bottom: 0;">
			<button onclick="cancel()" tapmode="" id="button2" class="H-button H-font-size-18 H-outline-none H-padding-vertical-both-10 H-padding-horizontal-both-20 H-theme-font-color-white H-opacity-1-half" style="border: 1px solid #FFF; width: 50%; float: left;">
				取消订单
			</button>
			<button onclick="sure()" tapmode="" id="button3" class="H-button H-width-50 H-font-size-18 H-outline-none H-padding-vertical-both-10 H-padding-horizontal-both-20 H-theme-font-color-white" style="border: 1px solid #FF8453;width: 50%; float: left;">
				去付款
			</button>
		</div>
	</div>
	<script id="tpl_itemList" type="text/html">
		<div class="H-width-100-percent">
			<div class="H-flex-item H-theme-font-color-white H-flexbox-horizontal" style="background-image: linear-gradient(120deg, #FA6B30 0%, #FF8656 100%);">
				<div class="H-padding-vertical-both-25 H-margin-horizontal-both-10">
					<div class="H-font-size-16">
						等待付款
					</div>
					<div class="H-font-size-15 H-margin-vertical-top-3">
						剩23小时53分21秒自动关闭
					</div>
				</div>
				<div class="H-center-all H-margin-horizontal-both-25" style="margin-bottom: auto; margin-top: auto;">
					<img src="../../image/callbackimg.png" alt="" title="" class="imgCache H-display-block" style="width: 75px; height: 75px;">
				</div>
			</div>
			<div class="H-flex-item H-theme-background-color-white H-padding-vertical-both-10 H-padding-horizontal-both-10">
				<div class="H-flexbox-horizontal H-theme-font-color-black H-opacity-1-half">
					<span>收货人 : [:=list.receive_address.receive_person:]</span>
					<span class="H-flex-item"></span>
					<span>[:=list.receive_address.contact_number:]</span>
				</div>
				<div class="H-theme-font-color-black H-opacity-1-half">
					收货地址 : [:=list.receive_address.detail_address:]
				</div>
			</div>
		</div>
		<div class="H-border-radius3-px H-theme-background-color-white H-margin-vertical-top-10 ">
			[: for (var i=0;i
			<list.op_order.length;i++) { :] <div class="H-flexbox-horizontal H-border-vertical-bottom-after">
				<div class="H-padding-vertical-both-10 H-center-all">
					<img src="[:=list.op_order[i].pro_pic+'?imageView2/1/w/200/h/200/interlace/0/q/100':]" srcs="" alt="" title="" class="imgCache H-display-block H-margin-horizontal-left-10" style="width: 65px; height: 65px;">
				</div>
				<div class="H-flex-item H-padding-10">
					<strong class="H-font-weight-normal font-weight-500 H-font-size-16 H-display-block H-text-show-row-1">[:=list.op_order[i].pro_name:]</strong>
					<div class=" H-theme-font-color-999 H-text-show-row-1 H-margin-vertical-top-5 H-font-size-13">
						规格: [:=list.op_order[i].pro_spec:]
					</div>
					<div class="H-text-show-row-2 H-font-size-13">
						<span>¥[:=list.op_order[i].pro_fee:]</span>
						<span class="H-float-right H-icon H-theme-font-color-999"><i class="H-iconfont H-icon-nice H-font-size-14"></i>x [:=list.op_order[i].pro_num:]</span>
					</div>
				</div>
		</div>
		<div class="H-flexbox-horizontal H-padding-vertical-both-10">
			<div class="H-flex-item H-font-size-13 H-padding-horizontal-left-10 H-opacity-1-half" style="width: 48%; margin-bottom: auto; margin-top: auto;">
				报名费 : ￥[:=list.op_order[i].log_fee:]
			</div>
			<div class="H-font-size-14 H-theme-font-color-999 H-padding-horizontal-right-10">
				<span style="color: #31304C;">合计：</span>
				<span style="color: #FC3337;">￥[:=list.op_order[i].pro_total_fee:]</span>
			</div>
		</div>
		[:}:]
		</div>
		<div class="H-border-radius3-px H-theme-background-color-white H-margin-vertical-top-10">
			<div class="H-padding-horizontal-left-12 H-padding-vertical-both-8">
				<div class="H-font-size-13 H-opacity-1-half">
					订单号 : [:=list.order_id:]
				</div>
				<div class="H-font-size-13 H-opacity-1-half">
					创建时间 : [:=list.create_time.replace('T',' ').split('.')[0]:]
				</div>
			</div>
		</div>
		<div class="H-width-100-percent" style="position: fixed; bottom: 0;">
			[:if(list.isManage==0){:]
			<button onclick="cancel()" tapmode="" id="button2" class="H-button H-font-size-18 H-outline-none H-padding-vertical-both-10 H-padding-horizontal-both-20 H-theme-font-color-white H-opacity-1-half" style="border: 1px solid #FFF; width: 50%; float: left;">
						取消订单
				</button>
			<button onclick="wxOrderPay()" tapmode="" id="button3" class="H-button H-width-50 H-font-size-18 H-outline-none H-padding-vertical-both-10 H-padding-horizontal-both-20 H-theme-font-color-white" style="border: 1px solid #FF8453;width: 50%; float: left;">
						去付款
				</button> [:}else{:]
			<button onclick="openPhone('[:=list.receive_address.contact_number:]')" tapmode="" id="button3" class="H-button H-font-size-18 H-outline-none H-padding-vertical-both-10 H-padding-horizontal-both-20 H-theme-font-color-white" style="border: 1px solid #FF8453;width: 100%;">
						联系买家
				</button> [:}:]
		</div>
	</script>
	<script src="../../script/api.js" type="text/javascript"></script>
	<script src="../../script/H.js" type="text/javascript"></script>
	<script src="../../script/setting.js" type="text/javascript"></script>
	<script src="../../script/zepto.min.js" type="text/javascript"></script>
	<script type="text/javascript">
		var wxPay = null,
			order_id = null;
		apiready = function() {
			initDatas();
			wxPay = api.require('wxPay');
		};

		function initDatas() {
			var id = api.pageParam.id;
			log(id)
			var url = '/fenggou/orders/' + id + '/';
			ajaxs(url, 'get', null, true, function(ret) {
				log(ret, true);
				if (ret.id) {
					ret.isManage = api.pageParam.isManage;
					var html = H.tppl(H.D('#tpl_itemList').innerHTML, {
						list: ret
					});
					$("#itemList").html(html).fadeIn(300);
					order_id = ret.order_id;
					api.parseTapmode();
				} else {
					H.toast(ret.msg)
				}
			}, function(ret, err) {
				log(err, true);
			});
		};

		function openWins(title, name, url) {
			H.openWin('base_head_' + name, 'widget://html/comPages/baseNoBorder_head.html', {
				title: title,
				name: name,
				url: url
			});
		};

		function cancel() {
			api.closeWin();
		};


		function openDetail() {
			openWins('订单详情', 'play_waitAttendInfo_body', '../user/play_waitAttendInfo_body.html');
		};

		function openPhone(num) {
			api.call({
				type: 'tel_prompt',
				number: num
			});
		};
		//订单支付
		function wxOrderPay() {
			wechatPay(order_id);
		};

		function wechatPay(orderId) {
			var url = window.server + "/common/wechat/create/order/";
			api.ajax({
				url: url,
				method: 'post',
				data: {
					values: {
						order_id: orderId
					}
				},
				headers: {
					"X-CSRFToken": $api.getStorage('userInfo').token
				}
			}, function(ret, err) {
				log(ret, true)
				log(err, true)
				if (ret) {
					// goPayOrder(ret.data.wog, orderId);
					wechatApi(orderId);
				} else {
					api.alert({
						msg: JSON.stringify(err)
					});
				}
			});
		};

		function wechatApi(orderId) {
			var url = window.server + "/common/wechat/get/appapi/";
			api.ajax({
				url: url,
				method: 'post',
				data: {
					values: {
						order_id: orderId
					}
				},
				headers: {
					"X-CSRFToken": $api.getStorage('userInfo').token
				}
			}, function(ret, err) {
				log(ret, true)
				log(err, true)
				if (ret) {
					if (ret.success) {
						goPayOrder(ret.data, orderId);
					} else {
						H.toast(ret.msg)
					}
				} else {
					api.alert({
						msg: JSON.stringify(err)
					});
				}
			});
		};

		function goPayOrder(data, orderId) {
			wxPay.payOrder({
				apiKey: data.appid,
				orderId: data.prepayid,
				mchId: data.partnerid,
				nonceStr: data.noncestr,
				timeStamp: data.timestamp,
				sign: data.sign,
				package: 'Sign=WXPay'
			}, function(ret, err) {
				if (ret.status) {
					H.toast('支付成功')
					getOrderInfo(orderId);
				} else {
					H.toast('取消支付')
				}
			});
		};

		function getOrderInfo(orderId) {
			var url = '/common/wechat/order/query/';
			var data = {
				order_id: orderId
			};
			ajaxs(url, 'get', data, true, function(ret) {
				if (ret.success === true) {
					H.toast('支付成功');
					api.sendEvent({
					    name: 'loadGoodsCallback',
					    extra: {
					        key1: '1'
					    }
					});
					api.closeWin();
				} else {
					H.toast('支付异常，请重试')
				}
			}, function(ret, err) {})
		};
	</script>
</body>

</html>
