
<!doctype html>
<html id="ht">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>活动支付</title>
	<link href="../../css/Hui.css" rel="stylesheet" type="text/css" />
	<style type="text/css">
		html,
		body {
			background: rgba(0, 0, 0, 0.37);
			padding: 0;
			margin: 0;
		}

		.ios {
			background: rgba(0, 0, 0, 0.5);
		}

		.payActive .H-icon-radio-check {
			color: #FF7C47;
		}

		.payActive .H-icon-radio-check:before {
			content: "\f258";
		}
	</style>
</head>

<body class="H-flexbox-vertical" id="bdy">
	<div class="H-main H-flex-item H-overflow-scrolling"></div>
	<div id="enrol" class="H-theme-background-color-white">
		<header class="H-header H-theme-background-color-white">
			<span onclick="closeFrame()" tapmode="" class="H-icon H-position-relative H-display-inline-block H-float-left H-vertical-middle H-theme-font-color-999 H-padding-horizontal-both-12 H-z-index-100"><i class="H-iconfont H-icon-close H-font-size-18 H-vertical-middle"></i></span>
			<div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-666 H-position-absolute H-width-100-percent">
				填写报名信息
			</div>
		</header>
		<div id="content" class="H-theme-background-color-white H-padding-vertical-both-10 H-border-vertical-top-after">
			<div class="H-channel-text H-flex-item H-font-size-16 H-theme-font-color-999 H-padding-10 H-margin-horizontal-right-10 H-text-show-row-1">
				姓名
			</div>
			<div class="H-padding-horizontal-both-10">
				<div class="H-search H-flexbox-horizontal H-box-sizing-border-box H-border-radius-5 H-overflow-hidden" style="background-color: #F9FAFC;">
					<input id="name" type="text" name="keyword" placeholder="" class="H-border-none H-theme-background-color-transparent H-flex-item H-font-size-16 H-padding-horizontal-both-10 H-padding-vertical-both-8 H-vertical-align-middle">
				</div>
			</div>
			<div class="H-channel-text H-flex-item H-font-size-16 H-theme-font-color-999 H-padding-10 H-margin-horizontal-right-10 H-text-show-row-1">
				手机号
			</div>
			<div class="H-padding-horizontal-both-10">
				<div class="H-search H-flexbox-horizontal H-box-sizing-border-box H-border-radius-5 H-overflow-hidden" style="background-color: #F9FAFC;">
					<input id="phone" type="number" name="keyword" placeholder="" class="H-border-none H-theme-background-color-transparent H-flex-item H-font-size-16 H-padding-horizontal-both-10 H-padding-vertical-both-8 H-vertical-align-middle">
				</div>
			</div>
			<div class="H-channel-text H-flex-item H-font-size-16 H-theme-font-color-999 H-padding-10 H-margin-horizontal-right-10 H-text-show-row-1">
				报名人数
			</div>
			<div class="H-padding-horizontal-both-10">
				<div class="H-display-inline-block H-float-left H-vertical-middle H-overflow-hidden">
					<span onclick="actionNum(-1)" tapmode="" class="H-display-inline-block H-center-all H-border-radius-3" style="height: 35px;width:35px;background-color: #F4F5F6;"><i class="H-iconfont H-icon-minus H-font-size-14 H-theme-font-color-999"></i></span>
					<input id="num" type="number" value="1" class="H-theme-background-color-transparent H-font-size-16 H-text-align-center H-border-none H-box-sizing-border-box H-border-radius-3 H-margin-horizontal-both-8" style="height: 35px;width:35px;background-color: #F4F5F6;">
					<span onclick="actionNum(1)" tapmode="" class="H-display-inline-block H-border-radius-3 H-font-size-16 H-center-all" style="background-color: #F4F5F6;height: 35px;width:35px;"><i class="H-iconfont H-icon-plus H-font-size-14 H-theme-font-color-999"></i></span>
				</div>
			</div>
		</div>
		<div class="H-flexbox-horizontal H-box-sizing-border-box H-border-vertical-top-after">
			<div tapmode="" onclick="btnSubmit(0)" class="H-flex-item H-center-all H-padding-vertical-both-12 H-font-size-18 H-theme-background-color-white">
				<label class="H-theme-font-color-444">合计：</label>
				<label id="fee" style="color: #FF7C47;">¥10</label>
			</div>
			<div id="okBtnNext" tapmode="" onclick="submitBtn()" class="H-flex-item H-center-all H-padding-vertical-both-12 H-font-size-18 H-theme-font-color-white" style="background-color: #FF7C47;">
				下一步
			</div>
		</div>
	</div>
	<div id="pay" class="H-theme-background-color-white" style="display: none;">
		<header class="H-header H-theme-background-color-white H-border-vertical-bottom-after">
			<span onclick="backEnrol()" tapmode="" class="H-icon H-position-relative H-display-inline-block H-float-left H-vertical-middle H-theme-font-color-999 H-padding-horizontal-both-12 H-z-index-100"><i class="H-iconfont H-icon-target-back H-font-size-18 H-vertical-middle"></i></span>
			<div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-666 H-position-absolute H-width-100-percent">
				选择支付方式
			</div>
			<span onclick="closeFrame()" tapmode="" class="H-icon H-position-relative H-display-inline-block H-float-right H-vertical-middle H-theme-font-color-999 H-padding-horizontal-both-15 H-z-index-100"><i class="H-iconfont H-icon-close H-font-size-18 H-vertical-middle"></i></span>
		</header>
		<div id="payList">
			<div onclick="selectPay(this)" tapmode="" data-type="wxpay" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active payActive">
				<div class="H-padding-horizontal-left-10 H-padding-vertical-both-10">
					<span class="H-icon H-center-all H-theme-background-color9 H-border-radius-circle H-margin-horizontal-auto" style="height: 42px; width: 42px; "><i class="H-iconfont H-icon-weixin H-font-size-22 H-theme-font-color-white"></i></span>
				</div>
				<div class="H-flex-item H-font-size-16 H-flexbox-vertical H-padding-horizontal-both-10">
					微信
				</div>
				<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-radio-check H-font-size-28 H-theme-font-color-999 H-vertical-middle"></i></span>
			</div>
			<div onclick="selectPay(this)" tapmode="" data-type="alipay" class="H-text-list H-flexbox-horizontal H-theme-background-color-white H-border-vertical-bottom-margin-both-10-after H-vertical-middle H-touch-active">
				<div class="H-padding-horizontal-left-10 H-padding-vertical-both-10">
					<span class="H-icon H-center-all H-theme-background-color1 H-border-radius-circle H-margin-horizontal-auto" style="height: 42px; width: 42px; "><i class="H-iconfont H-icon-alipay H-font-size-22 H-theme-font-color-white"></i></span>
				</div>
				<div class="H-flex-item H-font-size-16 H-flexbox-vertical H-padding-horizontal-both-10">
					支付宝
				</div>
				<span class="H-icon H-padding-horizontal-right-10 H-display-block"><i class="H-iconfont H-icon-radio-check H-theme-font-color-999 H-font-size-28 H-vertical-middle"></i></span>
			</div>
		</div>
		<div class="H-padding-vertical-bottom-10 H-theme-background-color-white"></div>
		<div class="H-flexbox-horizontal H-box-sizing-border-box">
			<div tapmode="" onclick="btnSubmit()" class="H-flex-item H-center-all H-padding-vertical-both-12 H-font-size-18 H-theme-font-color-white" style="background-color: #FF7C47;">
				确认支付
			</div>
		</div>
	</div>
	<script src="../../script/api.js" type="text/javascript"></script>
	<script src="../../script/H.js" type="text/javascript"></script>
	<script src="../../script/setting.js" type="text/javascript"></script>
	<script src="../../script/zepto.min.js" type="text/javascript"></script>
	<script type="text/javascript">
		var has_fee = 0,fee = 0;
		H.ready(function() {
			has_fee = api.pageParam.has_fee;
			fee = api.pageParam.fee;
			setBg();
			if (has_fee == 0) {
				$('#fee').html('¥0');
				$('#okBtnNext').html('确定');
			}else{
				$('#fee').html('¥'+fee);
			}
		});
		function actionNum(num){
			if(num==-1){
				var val = parseInt($('#num').val());
				if(val>1){
					$('#num').val(val-1);
					$('#fee').html('¥'+(val-1)*fee);
				}
			}else{
				var val = parseInt($('#num').val());
				var count = parseInt(api.pageParam.personCount) - parseInt(api.pageParam.person);
				if(val<count){
					$('#num').val(val+1);
					$('#fee').html('¥'+(val+1)*fee);
				}else{
					H.toast('当前报名人数仅剩'+count)
				}
			}
		};
		function selectPay(obj) {
			var type = $(obj).attr('data-type');
			$(obj).addClass('payActive').siblings().removeClass('payActive');
		};

		function submitBtn() {
			var name = $('#name').val();
			var phone = $('#phone').val();
			var num = $('#num').val();
			if(name==''){
				return H.toast('姓名不能为空')
			}
			if(phone==''){
				return H.toast('手机号不能为空')
			}
			var persons =  parseInt(api.pageParam.person) + parseInt(num);
			if(persons>parseInt(api.pageParam.personCount)){
				var count = parseInt(api.pageParam.personCount) - parseInt(api.pageParam.person);
				return H.toast('当前报名人数仅剩'+count)
			}
			if (has_fee == 0) {
				submitData(name,phone,num);
			} else {
				$("#enrol").css({
					"display": "none"
				});
				$("#pay").css({
					"display": "block"
				});
				submitData(name,phone,num);
			}
		};

		function submitData(name,phone,num) {
			var url = '/fengwan/user/';
			var data = {
				name: name,
				phone: phone,
				number: num,
				activity: api.pageParam.id,
				user: $api.getStorage('userInfo').user.id
			};
			ajaxs(url,'post',data,true,function(ret){

			},function(ret,err){
				if (ret) {
					H.toast('恭喜您报名成功');
					api.execScript({
							frameName: 'activity_body',
							script: 'initDatas();'
					});
					api.closeFrame();
				} else {
					log(err,true)
					if(err.body.hasOwnProperty("non_field_errors")){
						H.toast('您已经报名过此活动了～');
					}
				}
				return;
			});

			// api.ajax({
			// 	url: url,
			// 	method: 'post',
			// 	data: {
			// 		values: {
			// 			name: name,
			// 			phone: phone,
			// 			number: num,
			// 			activity: api.pageParam.id,
			// 			user: api.pageParam.uid
			// 		}
			// 	},
			// 	headers : {
			// 		"X-CSRFToken" : $api.getStorage('userInfo')
			// 	}
			// }, function(ret, err) {
			// 	log(ret, true);
			// 	//console.log(JSON.stringify(err));
			// 	if (ret) {
			// 		//alert(JSON.stringify(ret));
			// 		H.toast('恭喜您报名成功');
			// 		api.execScript({
			// 				frameName: 'activity_body',
			// 				script: 'initDatas();'
			// 		});
			// 		api.closeFrame();
			// 	} else {
			// 		// H.toast(JSON.stringify(err));
			// 		log(err,true)
			// 		if(err.body.hasOwnProperty("non_field_errors")){
			// 			H.toast('您已经报名过此活动了～');
			// 		}
			// 	}
			// });
		};

		function backEnrol() {
			$("#enrol").css({
				"display": "block"
			});
			$("#pay").css({
				"display": "none"
			});
		};

		function setBg() {
			if (api.systemType == "ios") {
				$("#ht,#bdy").css({
					"background": "rgba(0,0,0,0.6)"
				});
			}
		};

		function btnSubmit() {
			H.toast("开发中")
		};

		function closeFrame() {
			api.closeFrame();
		};
	</script>
</body>

</html>
